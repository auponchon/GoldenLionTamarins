---
title: "Landscape analysis"
author: "Aurore Ponchon"
format: html
editor: visual
---

# Linking landscape composition with individual movements

```{r}

library(here)
library(raster)
library(tidyverse)
library(sf)
library(landscapemetrics)
source(here::here("R","progress_bar.R"))
#import landscape files

#land cover for each each
rast<-list.files(here::here("data","RawData","Landscape","Rasters land cover"),
                 full.names=T)
#single forest patches
land<-sf::read_sf(here::here("data","RawData","Landscape","Shapefiles Landscape AMLD", 
                             "SIG-EDUC Redescobrindo 2021 - Fragmentos de Vegetação.shp"))
#conservation units (patches)
ummp<-sf::read_sf(here::here("data","RawData","Landscape","Shapefiles Landscape AMLD",
                             "SIG-LGCI_UMMP-13.shp")) %>% 
  dplyr::select(Id,UMMPs,geometry)

loc<-read.table(here::here("data","rawData","Landscape","RegionsName.csv"),
                header=T,sep=";") %>% 
  dplyr::rename(Long=CENTROIDE.X.UTM.SAD69.23S,
                Lat=CENTROIDE.Y.UTM.SAD69.23S,
                Group=Abreviation) %>% 
  dplyr::select(-Platform,-City) %>% 
  dplyr::filter_all(any_vars(!is.na(.))) %>% 
  sf::st_as_sf(., coords = c("Long","Lat")) %>% 
  sf::st_set_crs(31983)

#projection for Brazil
proj<-"+proj=utm +zone=23 +south +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +type=crs"

#etxent of study area in geographic coordinates
extreg<-extent(-42.7,-41.9,-22.9,-22.3)
size<-NULL

rastall<-raster(rast[1]) %>% 
  raster::crop(.,extreg) %>%    #crop to the study region
  projectRaster(., crs=proj ,method="ngb",res=30) %>%  #project 
  mask(.,ummp)

patches<-raster(rast[1]) %>% 
  raster::crop(.,extreg) %>%    #crop to the study region
  projectRaster(., crs=proj ,method="ngb",res=30) %>%  #project 
  mask(.,ummp)


for (i in 1:length(rast)){
#i<-1

ummp<-sf::read_sf(here::here("data","RawData","Landscape","Shapefiles Landscape AMLD", "SIG-LGCI_UMMP-13.shp")) %>% 
  dplyr::select(Id,UMMPs,geometry)

land<-sf::read_sf(here::here("data","RawData","Landscape","Shapefiles Landscape AMLD", "SIG-EDUC Redescobrindo 2021 - Fragmentos de Vegetação.shp")) 


rast1<-raster(rast[i]) %>% 
  raster::crop(.,extreg) %>%    #crop to the study region
  projectRaster(., crs=proj ,method="ngb",res=30) %>%  #project 
  mask(.,ummp)

forest<-c(3,5,49)
notforest<-c(9,11,21,29)
buildings<-c(15,23,24,25)
agri<-41
water<-c(30,31,32,33)

#reassign codes for different habitats
# 0 = sea
# 3 = 5 = 49 = forest
# 9 = 11 = 21 = 29 = vegetation not forest
# 15 = 24 = 25 = buildings
# 41 = agriculture 
# 12 = 13 = 30 = 31 = 32 = 41 = NA
# 33 = water

rast1[rast1==0]<-NA
rast1[rast1 %in% forest]<-1
rast1[rast1 %in% notforest]<-2
rast1[rast1==agri]<-3
rast1[rast1 %in% water]<-4
rast1[rast1 %in% buildings]<-5

setTxtProgressBar(progress_bar(length(rast)),i)  

#check_landscape(rast1)
#show_patches(rast1,class="all")
zz<- get_patches(rast1,class=1)
zzz<-zz$layer_1$class_1
names(zzz)<-paste("cover",parse_number(rast[i]),sep="")
patches<-stack(zzz,patches)


#ll<-get_patches(rast1,class=1)
xx<-spatialize_lsm(rast1, what = "lsm_p_area")
rr<-xx$layer_1$lsm_p_area
names(rr)<-paste("cover",parse_number(rast[i]),sep="")

#show_lsm(rast1, what = "lsm_p_area", class=1,labels = TRUE)
 rastall<-stack(rr,rastall)
 
yy<-extract_lsm(rast1,loc,class=1)  %>% 
  dplyr:: mutate(Year=paste("cover",readr::parse_number(rast[i]),sep=""))
 
  size<-rbind(size,yy)

 
}


raster::writeRaster(rastall,
                    filename=here::here("data",
                                       "NewlyCreatedData",
                                       "Landscape raster",
                                       "SizeAreaRaster.asc"),
                    bylayer=T,
                    overwrite=T)

raster::writeRaster(patches,
                    filename=here::here("data",
                                       "NewlyCreatedData",
                                       "Landscape raster",
                                       "PatchRaster.asc"),
                    bylayer=T,
                    overwrite=T)

save(size,file=here::here("data","NewlyCreatedData","SizeArea_table.RData"))

```
