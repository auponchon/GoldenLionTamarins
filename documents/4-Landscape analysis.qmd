---
title: "Landscape analysis"
author: "Aurore Ponchon"
format: html
editor: visual
---

# Linking landscape composition with individual movements

```{r}

library(here)
library(raster)
library(tidyverse)
library(sf)
library(landscapemetrics)
source(here::here("R","progress_bar.R"))
#import landscape files

#land cover for each each
rast<-list.files(here::here("data","RawData","Landscape","Rasters land cover"),
                 full.names=T)
#single forest patches
land<-sf::read_sf(here::here("data","RawData","Landscape","Shapefiles Landscape AMLD", 
                             "SIG-EDUC Redescobrindo 2021 - Fragmentos de Vegetação.shp"))
#conservation units (patches)
ummp<-sf::read_sf(here::here("data","RawData","Landscape","Shapefiles Landscape AMLD",
                             "SIG-LGCI_UMMP-13.shp")) %>% 
  dplyr::select(Id,UMMPs,geometry)

loc<-read.table(here::here("data","rawData","Landscape","RegionsName.csv"),
                header=T,sep=";") %>% 
  dplyr::rename(Long=CENTROIDE.X.UTM.SAD69.23S,
                Lat=CENTROIDE.Y.UTM.SAD69.23S,
                Group=Abreviation) %>% 
  dplyr::select(-Platform,-City) %>% 
  dplyr::filter_all(any_vars(!is.na(.))) %>% 
  sf::st_as_sf(., coords = c("Long","Lat")) %>% 
  sf::st_set_crs(31983)

#projection for Brazil
proj<-"+proj=utm +zone=23 +south +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +type=crs"

coverStack<-purrr::map(rast,create_raster_stack,.progress=T)
save(coverStack, file=here::here("data","NewlyCreatedData","Cover_rasters.RData"))

#etxent of study area in geographic coordinates
extreg<-extent(-42.7,-41.9,-22.9,-22.3)
size<-NULL

#create an initial raster for size area
rastall<-create_raster_stack(rast[1])

#create an initial raster for patches
patches<-create_raster_stack(rast[1])

ummp<-sf::read_sf(here::here("data","RawData","Landscape","Shapefiles Landscape AMLD", "SIG-LGCI_UMMP-13.shp")) %>% 
  dplyr::select(Id,UMMPs,geometry)

land<-sf::read_sf(here::here("data","RawData","Landscape","Shapefiles Landscape AMLD", "SIG-EDUC Redescobrindo 2021 - Fragmentos de Vegetação.shp")) 


for (i in 1:length(rast)){
# i<-2

#get land cover
rast1<-create_raster_stack(rast[i])


#assign habitat types


setTxtProgressBar(progress_bar(length(rast)),i)  

#check_landscape(rast1)
#show_patches(rast1,class="all")
zz<- get_patches(rast1,class=1)
zzz<-zz$layer_1$class_1
names(zzz)<-paste("Pateches",parse_number(rast[i]),sep="")
patches<-stack(zzz,patches)


#ll<-get_patches(rast1,class=1)
xx<-spatialize_lsm(rast1, what = "lsm_p_area")
rr<-xx$layer_1$lsm_p_area
names(rr)<-paste("Area",parse_number(rast[i]),sep="")

#show_lsm(rast1, what = "lsm_p_area", class=1,labels = TRUE)
 rastall<-stack(rr,rastall)
 
yy<-extract_lsm(rast1,loc,class=1)  %>% 
  dplyr:: mutate(Year=paste("cover",readr::parse_number(rast[i]),sep=""))
 
  size<-rbind(size,yy)
 
}


terra::writeRaster(rastall,
                    filename=here::here(paste0("data",
                                       "NewlyCreatedData",
                                       "Landscape raster",
                                       names(rastall))),
                    overwrite=T)

terra::writeRaster(patches,
                    filename=here::here(paste0("data",
                                       "NewlyCreatedData",
                                       "Landscape raster",
                                       names(patches)),
                    overwrite=T,
                    bylayer=T)


save(size,file=here::here("data","NewlyCreatedData","SizeArea_table.RData"))
save(rastall,file=here::here("data","NewlyCreatedData","Raster_size.RData"))
save(patches,file=here::here("data","NewlyCreatedData","Raster_patches.RData"))


sizearea<-terra::extract(rastall,loc) %>% 
  as.data.frame(.) %>% 
   cbind(loc) %>% 
  pivot_longer(cols=1:30,
               names_to="Cover",
               values_to="Size") %>% 
  dplyr::mutate(Year=parse_number(Cover),
                Fragment.Region=as.factor(Fragment.Region),
                Group=as.factor(Group),
                Patch= as.factor(brasil_coverage_1990)) %>% 
  # dplyr::filter(Group=="SI2" | Group=="PA"| Group=="AL"|Group=="SP"|
  #                 Group=="AFII" | Group=="TMII" | Group== "LA2" |
  #                 Group=="LP" |Group=="CLA" | Group=="Ataliba") %>% 
  dplyr::arrange(Group,Year)


ggg<-ggplot(sizearea,aes(x=Year,y=Size,group=Fragment.Region)) +
  geom_line(aes(color=Fragment.Region))
  print(ggg)
```
