---
title: "Landscape analysis"
author: "Aurore Ponchon"
format: html
editor: visual
---

# Linking landscape composition with individual movements

```{r}

library(here)
library(raster)
library(tidyverse)
library(sf)
library(landscapemetrics)
source(here::here("R","progress_bar.R"))
source(here::here("R","create_raster.R"))
#import landscape files

#land cover for each each
rast<-list.files(here::here("data","RawData","Landscape","Rasters land cover"),
                 full.names=T)
#single forest patches
land<-sf::read_sf(here::here("data","RawData","Landscape","Shapefiles Landscape AMLD", 
                             "SIG-EDUC Redescobrindo 2021 - Fragmentos de Vegetação.shp"))
#conservation units (patches)
ummp<-sf::read_sf(here::here("data","RawData","Landscape","Shapefiles Landscape AMLD",
                             "SIG-LGCI_UMMP-13.shp")) %>% 
  dplyr::select(Id,UMMPs,geometry)

loc<-read.table(here::here("data","rawData","Landscape","RegionsName.csv"),
                header=T,sep=";") %>% 
  dplyr::rename(Long=CENTROIDE.X.UTM.SAD69.23S,
                Lat=CENTROIDE.Y.UTM.SAD69.23S,
                Group=Abreviation) %>% 
  dplyr::select(-Platform,-City) %>% 
  dplyr::filter_all(any_vars(!is.na(.))) %>% 
  sf::st_as_sf(., coords = c("Long","Lat")) %>% 
  sf::st_set_crs(31983)

#etxent of study area in geographic coordinates
extreg<-extent(-42.7,-41.9,-22.9,-22.3)
size<-NULL


#projection for Brazil
proj<-"+proj=utm +zone=23 +south +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +type=crs"

coverStack<-purrr::map(rast,create_raster_stack,.progress=T)
save(coverStack, file=here::here("data","NewlyCreatedData","Cover_rasters.RData"))


#create an initial raster for size area
rastall<-create_raster_stack(rast[1])

#create an initial raster for patches
patches<-create_raster_stack(rast[1])

ummp<-sf::read_sf(here::here("data","RawData","Landscape","Shapefiles Landscape AMLD", "SIG-LGCI_UMMP-13.shp")) %>% 
  dplyr::select(Id,UMMPs,geometry)

land<-sf::read_sf(here::here("data","RawData","Landscape","Shapefiles Landscape AMLD", "SIG-EDUC Redescobrindo 2021 - Fragmentos de Vegetação.shp")) 


for (i in 1:length(rast)){
# i<-2

#get land cover
rast1<-create_raster_stack(rast[i])


#assign habitat types


setTxtProgressBar(progress_bar(length(rast)),i)  

#check_landscape(rast1)
#show_patches(rast1,class="all")
zz<- get_patches(rast1,class=1)
zzz<-zz$layer_1$class_1
names(zzz)<-paste("Pateches",parse_number(rast[i]),sep="")
patches<-stack(zzz,patches)


#ll<-get_patches(rast1,class=1)
xx<-spatialize_lsm(rast1, what = "lsm_p_area")
rr<-xx$layer_1$lsm_p_area
names(rr)<-paste("Area",parse_number(rast[i]),sep="")

#show_lsm(rast1, what = "lsm_p_area", class=1,labels = TRUE)
 rastall<-stack(rr,rastall)
 
yy<-extract_lsm(rast1,loc,class=1)  %>% 
  dplyr:: mutate(Year=paste("cover",readr::parse_number(rast[i]),sep=""))
 
  size<-rbind(size,yy)
 
}


terra::writeRaster(rastall,
                    filename=here::here(paste0("data",
                                       "NewlyCreatedData",
                                       "Landscape raster",
                                       names(rastall))),
                    overwrite=T)

terra::writeRaster(patches,
                    filename=here::here(paste0("data",
                                       "NewlyCreatedData",
                                       "Landscape rast")),
                    overwrite=T,
                    bylayer=T)


save(size,file=here::here("data","NewlyCreatedData","SizeArea_table.RData"))
save(rastall,file=here::here("data","NewlyCreatedData","Raster_size.RData"))
save(patches,file=here::here("data","NewlyCreatedData","Raster_patches.RData"))

load(here::here("Data","NewlyCreatedData","clean_raw_data_long.RData"))

group.reg<-data.clean %>% 
  ungroup() %>% 
  distinct_at(vars(Year,Group,UMMPs), keep_all=F)

sizearea<-terra::extract(rastall,loc) %>% 
  as.data.frame(.) %>% 
   cbind(loc) %>% 
  left_join (group.reg, by="Group") %>% 
  pivot_longer(cols=1:30,
               names_to="Cover",
               values_to="Size") %>% 
  dplyr::mutate(Year=parse_number(Cover),
                Fragment.Region=as.factor(Fragment.Region),
                Group=as.factor(Group),
                Patch= as.factor(brasil_coverage_1990),
                UMMPs=as.factor(UMMPs)) %>% 
# dplyr::filter(UMMPs=="Rio Vermelho") %>%    #Aldeia II,  Rio Vermelho
  dplyr::arrange(Group,Year) %>% 
  drop_na() %>% 
  distinct()


ggg<-ggplot(sizearea,aes(x=Year,y=Size,group=Group)) +
  geom_line(aes(color=Group),show.legend = F) +
  facet_wrap(.~UMMPs, nrow=2) 
  print(ggg)
  
  


library(gganimate)
library(gifski)

  

mydf <- purrr::map_dfr(
  coverStack, 
  ~setNames(as.data.frame(as(., "SpatialPixelsDataFrame")), c('value', 'x', 'y')), 
  .id = 'year'
)

gg <- ggplot(mydf, 
  aes(x = x, y = y, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c() +
  ggthemes::theme_map()

gganim <- gg + 
  transition_time(as.numeric(year)) +
   labs(subtitle = "Year: {round(frame_time,digits=0)}") 
   

animate(gganim, height = 1000, width =2000,res=300,fps=5,
        renderer = gifski_renderer())
anim_save(filename = here::here("outputs","GIF_range_expansion.gif"))
```
